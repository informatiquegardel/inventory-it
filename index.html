<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Inventaire IT - Mono Utilisateur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body { background: #f7f8fb; }
    .low-stock { background-color: #ffe5e5 !important; }
    .table-responsive { max-height: 60vh; overflow-y: auto; }
  </style>
</head>
<body class="p-3">

<div class="container">
  <h2 class="mb-3">üì¶ Inventaire IT ‚Äî Version Mono</h2>

  <!-- UTILISATEUR -->
  <div class="mb-3 d-flex gap-2">
    <input id="userInput" class="form-control" placeholder="Utilisateur responsable">
    <input id="searchInput" class="form-control" placeholder="Recherche par nom">
    <select id="categoryFilter" class="form-select">
      <option value="">Toutes cat√©gories</option>
    </select>
  </div>

  <!-- AJOUT ARTICLE -->
  <div class="card mb-3">
    <div class="card-body row g-2">
      <input id="name" class="form-control col" placeholder="Nom">
      <input id="category" class="form-control col" placeholder="Cat√©gorie">
      <input id="qty" type="number" class="form-control col" placeholder="Quantit√©">
      <input id="location" class="form-control col" placeholder="Localisation">
      <input id="state" class="form-control col" placeholder="√âtat">
      <button class="btn btn-primary col" onclick="addItem()">Ajouter</button>
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="mb-3 d-flex gap-2">
    <button class="btn btn-success" onclick="exportCSV()">Exporter CSV</button>
    <input type="file" id="importFile" accept=".csv" class="form-control">
    <button class="btn btn-secondary" onclick="document.getElementById('historyModal').classList.add('show')">Historique</button>
  </div>

  <!-- TABLE -->
  <div class="table-responsive">
    <table class="table table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Nom</th>
          <th>Cat√©gorie</th>
          <th>Quantit√©</th>
          <th>Localisation</th>
          <th>√âtat</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<!-- MODAL HISTORIQUE -->
<div class="modal" tabindex="-1" id="historyModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content p-3">
      <h5>Historique des mouvements</h5>
      <button class="btn btn-danger mb-2" onclick="clearHistory()">Vider historique</button>
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Date</th>
            <th>Article</th>
            <th>Mouvement</th>
            <th>Qt√©</th>
            <th>Utilisateur</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
      <button class="btn btn-secondary" onclick="document.getElementById('historyModal').classList.remove('show')">Fermer</button>
    </div>
  </div>
</div>

<script>
const STORAGE_KEY = "itInventory_mono";
const HISTORY_KEY = "itInventory_history";
let items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];

const tableBody = document.getElementById("tableBody");
const historyBody = document.getElementById("historyBody");
const searchInput = document.getElementById("searchInput");
const categoryFilter = document.getElementById("categoryFilter");
const userInput = document.getElementById("userInput");

if(localStorage.getItem("currentUser")){
  userInput.value = localStorage.getItem("currentUser");
}

userInput.addEventListener("change", ()=>{
  localStorage.setItem("currentUser", userInput.value.trim());
});

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
}

function saveHistory(){
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
}

function logMove(name, delta){
  const user = localStorage.getItem("currentUser") || "Inconnu";
  history.unshift({
    date: new Date().toLocaleString(),
    name,
    type: delta > 0 ? "Entr√©e" : "Sortie",
    qty: Math.abs(delta),
    user
  });
  saveHistory();
  renderHistory();
}

function addItem(){
  const item = {
    id: Date.now(),
    name: name.value,
    category: category.value,
    qty: parseInt(qty.value),
    location: location.value,
    state: state.value
  };
  items.push(item);
  save();
  logMove(item.name, item.qty);
  render();
}

function updateQty(id, value){
  const item = items.find(i => i.id === id);
  const delta = value - item.qty;
  item.qty = value;
  save();
  logMove(item.name, delta);
  render();
}

function removeItem(id){
  items = items.filter(i => i.id !== id);
  save();
  render();
}

function render(){
  tableBody.innerHTML = "";
  categoryFilter.innerHTML = `<option value="">Toutes cat√©gories</option>`;

  const categories = [...new Set(items.map(i => i.category))];
  categories.forEach(c =>{
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    categoryFilter.appendChild(opt);
  });

  const filtered = items.filter(i =>
    i.name.toLowerCase().includes(searchInput.value.toLowerCase()) &&
    (categoryFilter.value === "" || i.category === categoryFilter.value)
  );

  filtered.forEach(item =>{
    const tr = document.createElement("tr");
    if(item.qty < 5) tr.classList.add("low-stock");

    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${item.category}</td>
      <td><input type="number" class="form-control" value="${item.qty}" onchange="updateQty(${item.id}, this.value)"></td>
      <td>${item.location}</td>
      <td>${item.state}</td>
      <td><button class="btn btn-danger btn-sm" onclick="removeItem(${item.id})">X</button></td>
    `;
    tableBody.appendChild(tr);
  });
}

function renderHistory(){
  historyBody.innerHTML = "";
  history.forEach(h=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${h.date}</td>
      <td>${h.name}</td>
      <td>${h.type}</td>
      <td>${h.qty}</td>
      <td>${h.user}</td>
    `;
    historyBody.appendChild(tr);
  });
}

function clearHistory(){
  if(confirm("Supprimer tout l'historique ?")){
    history = [];
    saveHistory();
    renderHistory();
  }
}

function exportCSV(){
  let csv = "Nom,Cat√©gorie,Quantit√©,Localisation,√âtat\n";
  items.forEach(i=>{
    csv += `${i.name},${i.category},${i.qty},${i.location},${i.state}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "inventaire.csv";
  a.click();
}

document.getElementById("importFile").addEventListener("change", function(e){
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function(){
    const lines = reader.result.split("\n").slice(1);
    items = lines.filter(l => l.trim()).map(l=>{
      const [name, category, qty, location, state] = l.split(",");
      return { id: Date.now()+Math.random(), name, category, qty: parseInt(qty), location, state };
    });
    save();
    render();
  };
  reader.readAsText(file);
});

searchInput.addEventListener("input", render);
categoryFilter.addEventListener("change", render);

render();
renderHistory();
</script>

</body>
</html>
